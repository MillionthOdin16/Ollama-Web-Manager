<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Web Manager V3</title>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neat.min.css">

    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-focus-border: var(--primary-color);
            --primary-rgb: 0, 123, 255; /* For focus ring */
            --error-color: #dc3545;
            --error-hover: #c82333;
            --warning-color: #ffc107;
            --warning-hover: #e0a800;
            --success-color: #28a745;
            --success-hover: #218838;
            --info-color: #17a2b8;
            --info-hover: #138496;
            --hover-bg: #f8f9fa;
            --code-bg: #f1f3f5;
            --code-text: #212529;
            --button-text: #ffffff;
            --disabled-bg: #e9ecef;
            --disabled-text: #6c757d;
            --chat-user-bg: #e7f5ff;
            --chat-model-bg: #f8f9fa;
            --tab-inactive-bg: transparent; /* Changed */
            --tab-active-bg: var(--card-bg); /* Used implicitly by tab content */
            --tab-active-border: var(--primary-color);
            --toast-success-bg: #d4edda;
            --toast-success-text: #155724;
            --toast-error-bg: #f8d7da;
            --toast-error-text: #721c24;
            --toast-info-bg: #d1ecf1;
            --toast-info-text: #0c5460;
            --cm-bg: var(--input-bg);
            --cm-text: var(--text-color);
            --cm-gutter-bg: var(--hover-bg);
            --cm-border: var(--input-border);
            --cm-matchingbracket-outline: #aaa;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --border-radius: 6px;
        }

        [data-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --text-muted: #adb5bd;
            --primary-color: #0d6efd;
            --primary-hover: #3b82f6;
            --secondary-color: #6c757d;
            --secondary-hover: #8a959f;
            --border-color: #495057;
            --card-bg: #343a40;
            --input-bg: #495057;
            --input-border: #6c757d;
            --input-focus-border: var(--primary-color);
            --primary-rgb: 13, 110, 253; /* For focus ring */
            --error-color: #f47174;
            --error-hover: #f68e91;
            --warning-color: #fcc419;
            --warning-hover: #fdd043;
            --success-color: #75b798;
            --success-hover: #8ec4ae;
            --info-color: #63c5da;
            --info-hover: #82d2e2;
            --hover-bg: #495057;
            --code-bg: #2b3035; /* Slightly different for code */
            --code-text: #f1f3f5;
            --button-text: #ffffff; /* Keep button text white usually */
            --disabled-bg: #495057;
            --disabled-text: #adb5bd;
            --chat-user-bg: #2c3e50;
            --chat-model-bg: #3a4a5d;
            --tab-inactive-bg: transparent; /* Changed */
            --tab-active-bg: var(--card-bg);
            --tab-active-border: var(--primary-color);
            --toast-success-bg: #1a3a24;
            --toast-success-text: #75b798;
            --toast-error-bg: #4a1c20;
            --toast-error-text: #f47174;
            --toast-info-bg: #0c343f;
            --toast-info-text: #63c5da;
            --cm-bg: var(--input-bg);
            --cm-text: var(--text-color);
            --cm-gutter-bg: #3a4a5d;
            --cm-border: var(--input-border);
            --cm-matchingbracket-outline: #888;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family);
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        header h1 { color: var(--primary-color); font-size: 2rem; font-weight: 600; }
        header h1 small { font-size: 0.6em; color: var(--text-muted); font-weight: 400; }
        .theme-switcher { display: flex; align-items: center; gap: 0.5rem; }
        .theme-toggle { padding: 0.4rem 0.8rem; cursor: pointer; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color); border-radius: var(--border-radius); font-size: 0.9rem; display: flex; align-items: center; gap: 0.4rem; }
        .theme-toggle svg { width: 16px; height: 16px; fill: currentColor; }

        /* Layout */
        main { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        section { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem 2rem; box-shadow: var(--box-shadow); }
        h2 { color: var(--primary-color); margin-bottom: 1.5rem; font-size: 1.6rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;}
        h2 svg.icon { width: 1.2em; height: 1.2em; vertical-align: -0.15em; }
        h3 { margin-top: 2rem; margin-bottom: 1rem; color: var(--text-muted); font-size: 1.3rem; font-weight: 500; }
        h4 { margin-top: 1.5rem; margin-bottom: 0.8rem; color: var(--text-color); font-size: 1.1rem; font-weight: 600; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }

        /* Forms & Controls */
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
        input[type="text"], input[type="url"], input[type="number"], input[type="search"], select, textarea:not(.cm-editor textarea) {
            width: 100%; padding: 0.75rem 1rem; margin-bottom: 1rem; border: 1px solid var(--input-border); border-radius: var(--border-radius); background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit;
        }
        input[type="text"]:focus, input[type="url"]:focus, input[type="number"]:focus, input[type="search"]:focus, select:focus, textarea:not(.cm-editor textarea):focus {
            border-color: var(--input-focus-border); outline: none; box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.25);
        }
        select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        [data-theme="dark"] select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23f8f9fa' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
        textarea:not(.cm-editor textarea) { min-height: 120px; resize: vertical; font-family: var(--font-family-monospace); }

        /* Buttons */
        button { background-color: var(--primary-color); color: var(--button-text); border: none; padding: 0.75rem 1.25rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s, opacity 0.2s; margin-right: 0.5rem; margin-bottom: 0.5rem; vertical-align: middle; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; line-height: 1.2; }
        button svg.icon { width: 1em; height: 1em; fill: currentColor; }
        button:hover:not(:disabled) { background-color: var(--primary-hover); opacity: 0.95; }
        button:disabled { background-color: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; opacity: 0.7; }
        .button-secondary { background-color: var(--secondary-color); } .button-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .button-danger { background-color: var(--error-color); } .button-danger:hover:not(:disabled) { background-color: var(--error-hover); }
        .button-warning { background-color: var(--warning-color); color: #333; } .button-warning:hover:not(:disabled) { background-color: var(--warning-hover); }
        .button-info { background-color: var(--info-color); } .button-info:hover:not(:disabled) { background-color: var(--info-hover); }
        .button-success { background-color: var(--success-color); } .button-success:hover:not(:disabled) { background-color: var(--success-hover); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; margin: 0 0.2rem; }
        .btn-icon { padding: 0.5rem; background: transparent; color: var(--text-muted); border: 1px solid transparent; line-height: 1; } /* Adjusted for icon-only */
        .btn-icon svg.icon { width: 1.1em; height: 1.1em; }
        .btn-icon:hover:not(:disabled) { background: var(--hover-bg); color: var(--primary-hover); border-color: var(--border-color); }

        /* Connection & Status */
        #connection { margin-bottom: 2rem; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin: 0 0.5rem; vertical-align: middle; transition: background-color 0.3s, box-shadow 0.3s; }
        .status-indicator.connected { background-color: var(--success-color); box-shadow: 0 0 5px var(--success-color); }
        .status-indicator.disconnected { background-color: var(--error-color); }
        .status-indicator.checking { background-color: var(--warning-color); animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        #ollamaInfo { font-size: 0.9em; color: var(--text-muted); margin-top: 0.5rem; min-height: 1.2em; }
        #connectionStatus { font-weight: 500; }

        /* Model List */
        #modelList input[type="search"] { margin-bottom: 1rem; padding: 0.5rem 0.8rem; }
        #modelList ul { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1rem; }
        #modelList li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; flex-wrap: wrap; gap: 0.5rem; }
        #modelList li:last-child { border-bottom: none; }
        #modelList li:hover { background-color: var(--hover-bg); }
        #modelList li .model-details { flex-grow: 1; margin-right: 1rem; display: flex; flex-direction: column; }
        #modelList li .model-name { font-weight: 600; word-break: break-all; font-size: 1.05rem; }
        #modelList li .model-meta { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
        #modelList li .model-actions { flex-shrink: 0; display: flex; gap: 0.3rem; }

        /* Operation Controls (Pull, Create etc.) */
        .operation-section { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .operation-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .operation-controls button { margin-bottom: 0; }
        .stop-button { display: none; } .stop-button.active { display: inline-flex; }
        progress { width: 100%; margin-top: 1rem; height: 8px; appearance: none; border: none; border-radius: 4px; overflow: hidden; background-color: var(--hover-bg); display: none; }
        progress.active { display: block; }
        progress::-webkit-progress-bar { background-color: var(--hover-bg); }
        progress::-webkit-progress-value { background-color: var(--success-color); transition: width 0.1s ease; }
        progress::-moz-progress-bar { background-color: var(--success-color); transition: width 0.1s ease; }
        .status-text { font-size: 0.9em; color: var(--text-muted); min-height: 1.2em; display: block; margin-top: 0.5rem; font-family: var(--font-family-monospace); }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; flex-wrap: wrap;}
        .tab-button { background-color: var(--tab-inactive-bg); border: none; border-bottom: 3px solid transparent; border-radius: 0; padding: 0.75rem 1.25rem; cursor: pointer; margin-right: 0.25rem; margin-bottom: -1px; color: var(--text-muted); transition: border-color 0.2s, color 0.2s; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;}
        .tab-button svg.icon { width: 1em; height: 1em; fill: currentColor; opacity: 0.7;}
        .tab-button.active { border-bottom: 3px solid var(--tab-active-border); color: var(--primary-color); font-weight: 600; }
        .tab-button.active svg.icon { opacity: 1; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CodeMirror */
        .CodeMirror { border: 1px solid var(--cm-border); border-radius: var(--border-radius); min-height: 150px; height: auto; font-family: var(--font-family-monospace); font-size: 0.95em; background-color: var(--cm-bg) !important; color: var(--cm-text) !important; }
        .cm-s-material-darker.CodeMirror { background-color: #263238 !important; color: #eeffff !important; } /* Example dark theme */
        .cm-s-neat.CodeMirror { background-color: #ffffff !important; color: #212529 !important; } /* Example light theme */
        .CodeMirror-gutters { background-color: var(--cm-gutter-bg) !important; border-right: 1px solid var(--cm-border); color: var(--text-muted); }
        .CodeMirror-matchingbracket { outline: 1px solid var(--cm-matchingbracket-outline); color: inherit !important; background-color: rgba(var(--primary-rgb), 0.1); }

        /* Chat Interface */
        #chatOutput { height: 450px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1rem; background-color: var(--input-bg); }
        .chat-message { margin-bottom: 1rem; padding: 1rem 1.2rem; border-radius: var(--border-radius); word-wrap: break-word; max-width: 85%; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1.5; }
        .chat-message.user { background-color: var(--chat-user-bg); margin-left: auto; text-align: left; border-radius: 12px 12px 0 12px; }
        .chat-message.assistant { background-color: var(--chat-model-bg); margin-right: auto; text-align: left; border: 1px solid var(--border-color); border-radius: 12px 12px 12px 0; }
        .chat-message strong { display: block; margin-bottom: 0.3rem; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .chat-message .message-content { white-space: pre-wrap; /* Preserve line breaks */ }
        /* Code blocks in chat */
        .chat-message pre { background-color: var(--code-bg); color: var(--code-text); padding: 1em; border-radius: var(--border-radius); overflow-x: auto; margin: 1em 0; font-family: var(--font-family-monospace); font-size: 0.9em; position: relative; border: 1px solid var(--border-color);}
        .chat-message code:not(pre code) { background-color: var(--code-bg); padding: 0.2em 0.4em; border-radius: 3px; font-family: var(--font-family-monospace); font-size: 0.9em; }
        .code-copy-button { position: absolute; top: 8px; right: 8px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; padding: 3px 6px; font-size: 0.8em; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; font-family: var(--font-family); }
        .chat-message pre:hover .code-copy-button { opacity: 1; }
        /* Chat Action Buttons (Regen, Copy) */
        .chat-message-actions { position: absolute; bottom: -10px; right: 10px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; z-index: 1; }
        .chat-message:hover .chat-message-actions { opacity: 1; }
        .chat-message-actions button { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center; color: var(--text-muted); box-shadow: var(--box-shadow); }
        .chat-message-actions button:hover { background: var(--hover-bg); color: var(--primary-hover); }
        .chat-message-actions button svg.icon { width: 14px; height: 14px; }

        /* Chat Input Area */
        #chatInputContainer { display: flex; gap: 0.5rem; align-items: flex-end; margin-top: 1rem; }
        #chatInputContainer textarea { flex-grow: 1; margin-bottom: 0; height: 50px; resize: none; overflow-y: hidden; font-size: 1rem; padding: 0.75rem 1rem; }
        #chatInputContainer .operation-controls { margin-top: 0; margin-bottom: 0; }
        #chatInputContainer button { height: 50px; margin-bottom: 0; flex-shrink: 0; }
        #chatOptions { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        #chatOptions label { margin-bottom: 0; }
        #chatOptions input { width: auto; flex-grow: 1; margin-bottom: 0; }
        .chat-session-controls { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Generate Tab - Advanced Options */
        .advanced-options { background-color: var(--hover-bg); border-radius: var(--border-radius); padding: 1.5rem; margin: 1.5rem 0; border: 1px solid var(--border-color); }
        .advanced-options h4 { margin-top: 0; margin-bottom: 1rem; font-size: 1rem; color: var(--text-muted); font-weight: 600; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .options-grid label { font-weight: normal; font-size: 0.85rem; }
        .options-grid input[type="number"] { padding: 0.5rem; font-size: 0.9rem; margin-bottom: 0; }

        /* Embeddings Tab */
        #embeddingsOutput { font-family: var(--font-family-monospace); font-size: 0.85em; word-break: break-all; max-height: 200px; overflow-y: auto; background-color: var(--code-bg); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-top: 1rem; }

        /* Editor Tab */
        #modelInfoDisplay pre { background-color: var(--code-bg); color: var(--code-text); padding: 1rem; border-radius: var(--border-radius); overflow-x: auto; font-size: 0.9em; margin-bottom: 1rem; border: 1px solid var(--border-color); max-height: 300px; white-space: pre-wrap; word-break: break-all;}
        .editor-note { font-size: 0.9em; color: var(--text-muted); background-color: var(--hover-bg); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border-left: 4px solid var(--info-color); display: flex; align-items: center; gap: 0.5rem; }
        .editor-note svg.icon { width: 1.1em; height: 1.1em; fill: var(--info-color); flex-shrink: 0; }

        /* Status Log */
        #statusLogContainer { margin-top: 1.5rem; }
        #statusLog { background-color: var(--code-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1rem; height: 250px; overflow-y: auto; font-size: 0.9rem; line-height: 1.5; font-family: var(--font-family-monospace); margin-bottom: 1rem; color: var(--code-text); }
        #statusLog p { margin-bottom: 0.5rem; word-wrap: break-word; white-space: pre-wrap; }
        #statusLog strong { color: var(--primary-color); margin-right: 0.5em; }
        #statusLog .log-error { color: var(--error-color); } #statusLog .log-error strong { color: var(--error-color); }
        #statusLog .log-warn { color: var(--warning-color); } #statusLog .log-warn strong { color: var(--warning-color); }
        #statusLog .log-success { color: var(--success-color); } #statusLog .log-success strong { color: var(--success-color); }
        #statusLog .log-info { color: var(--info-color); } #statusLog .log-info strong { color: var(--info-color); }
        #statusLog .log-stream { color: var(--text-muted); font-size: 0.9em; opacity: 0.8; } #statusLog .log-stream strong { color: var(--text-muted); }

        /* Spinner */
        .spinner { display: inline-block; border: 3px solid rgba(var(--primary-rgb), 0.3); border-radius: 50%; border-top-color: var(--primary-color); width: 1em; height: 1em; animation: spin 1s linear infinite; vertical-align: middle; }
        button .spinner { border-top-color: currentColor; border-left-color: transparent; border-right-color: transparent; border-bottom-color: transparent; width: 1em; height: 1em; } /* Spinner inside button */
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toasts / Notifications */
        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; transform: translateY(20px); font-size: 0.95rem; display: flex; align-items: center; gap: 0.8rem; max-width: 400px; pointer-events: none; } /* No pointer events */
        .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; } /* Allow pointer events when shown */
        .toast svg.icon { width: 1.2em; height: 1.2em; flex-shrink: 0; }
        .toast-success { background-color: var(--toast-success-bg); color: var(--toast-success-text); } .toast-success svg.icon { fill: var(--toast-success-text); }
        .toast-error { background-color: var(--toast-error-bg); color: var(--toast-error-text); } .toast-error svg.icon { fill: var(--toast-error-text); }
        .toast-info { background-color: var(--toast-info-bg); color: var(--toast-info-text); } .toast-info svg.icon { fill: var(--toast-info-text); }

        /* Responsive */
        @media (max-width: 768px) {
            main { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; }
            #modelList li { flex-direction: column; align-items: flex-start; }
            #modelList li .model-actions { margin-top: 0.5rem; width: 100%; justify-content: flex-end; }
            .tabs { justify-content: flex-start; /* Keep tabs left aligned on small screens */ overflow-x: auto; }
            #chatOutput { height: 350px; }
            #chatInputContainer { flex-direction: column; align-items: stretch; }
            #chatInputContainer button { width: 100%; height: auto; }
            #chatInputContainer textarea { height: auto; min-height: 50px; }
        }

        /* Embedded SVG Icons */
        .icon { display: inline-block; width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor; }
    </style>
</head>
<body>
    <!-- Embedded SVG Icons Definition -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-sun" viewBox="0 0 16 16"> <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 0a.5.5 0 0 1-.707.707l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707.707L2.343 3.757a.5.5 0 0 1 .707-.707l1.414 1.414z"/> </symbol>
        <symbol id="icon-moon" viewBox="0 0 16 16"> <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/> </symbol>
        <symbol id="icon-connect" viewBox="0 0 16 16"> <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v1H0V4zm0 3h16v4.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 11.5V7zm8.5 4.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/> </symbol>
        <symbol id="icon-refresh" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/> <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/> </symbol>
        <symbol id="icon-download" viewBox="0 0 16 16"> <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/> <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/> </symbol>
        <symbol id="icon-add" viewBox="0 0 16 16"> <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/> </symbol>
        <symbol id="icon-trash" viewBox="0 0 16 16"> <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/> <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/> </symbol>
        <symbol id="icon-copy" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/> </symbol>
        <symbol id="icon-info" viewBox="0 0 16 16"> <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/> </symbol>
        <symbol id="icon-edit" viewBox="0 0 16 16"> <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V12h2.293l6.5-6.5z"/> </symbol>
        <symbol id="icon-chat" viewBox="0 0 16 16"> <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/> </symbol>
        <symbol id="icon-play" viewBox="0 0 16 16"> <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/> </symbol>
        <symbol id="icon-code" viewBox="0 0 16 16"> <path d="M10.478 1.647a.5.5 0 1 0-.956.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/> </symbol>
        <symbol id="icon-stop" viewBox="0 0 16 16"> <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6A1.5 1.5 0 0 1 11 12.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/> </symbol>
        <symbol id="icon-save" viewBox="0 0 16 16"> <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5z"/> </symbol>
        <symbol id="icon-load" viewBox="0 0 16 16"> <path d="M12 2a1 1 0 0 1 1 1v2.5a.5.5 0 0 1-1 0V3a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h2a.5.5 0 0 1 0 1H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h8zm-6 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5H6zm4 1h-3v2h3V9z"/> <path d="M8.5 5.5a.5.5 0 0 0-1 0V15a.5.5 0 0 0 1 0V5.5z"/> <path d="M4.5 9a.5.5 0 0 1 0 1H3V9.5a.5.5 0 0 1-1 0V9a.5.5 0 0 1 .5-.5h1.5z"/> </symbol>
        <symbol id="icon-check" viewBox="0 0 16 16"> <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/> </symbol>
        <symbol id="icon-error" viewBox="0 0 16 16"> <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/> </symbol>
        <symbol id="icon-info-circle" viewBox="0 0 16 16"> <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/> <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/> </symbol>
        <symbol id="icon-vector" viewBox="0 0 16 16"> <path d="M5 1v1.11l-.804.161a.5.5 0 1 0 .198.978L5 3.069V4h-1V3.069L3.196 3.23a.5.5 0 1 0-.198.978L4 4.111V5H3v-.889l.804-.161a.5.5 0 1 0-.198-.978L3 3.069V2H2v1.069l-.804.161a.5.5 0 1 0 .198.978L2 4.069V5H1v-.889l.804-.161a.5.5 0 1 0-.198-.978L1 3.069V1H.5a.5.5 0 0 0 0 1h.5v3a.5.5 0 0 0 .5.5H2v.5l-1.201.24a.5.5 0 0 0-.299.95l1.5 3a.5.5 0 0 0 .9 0l1.5-3a.5.5 0 0 0-.3-.95L3.5 7.5V7H5V6.5l-.804-.161a.5.5 0 1 0-.198.978L5 7.5V8h1V7.5l-.804-.161a.5.5 0 1 0-.198.978L6 8.5V9h1V8.5l-.804-.161a.5.5 0 1 0-.198.978L7 9.5V10h1V9.5l-.804-.161a.5.5 0 1 0-.198.978L8 10.5V11h1v-.5l-.804-.161a.5.5 0 1 0-.198.978L9 11.5V12h1v-.5l-.804-.161a.5.5 0 1 0-.198.978L10 12.5V13h1v-.5l-.804-.161a.5.5 0 1 0-.198.978L11 13.5V14h.5a.5.5 0 0 0 0-1H11v-3a.5.5 0 0 0-.5-.5H10v-.5l1.201-.24a.5.5 0 0 0 .3-.95l-1.5-3a.5.5 0 0 0-.9 0l-1.5 3a.5.5 0 0 0 .3.95L9.5 7.5V8H8v-.5l1.201-.24a.5.5 0 0 0 .3-.95l-1.5-3a.5.5 0 0 0-.9 0l-1.5 3a.5.5 0 0 0 .3.95L7.5 6.5V7H6v-.5l1.201-.24a.5.5 0 0 0 .3-.95l-1.5-3a.5.5 0 0 0-.9 0l-1.5 3a.5.5 0 0 0 .3.95L5.5 5.5V6h-.5a.5.5 0 0 0-.5-.5V1.5a.5.5 0 0 0-.5-.5H3V1H2V0h3z"/> </symbol>
    </svg>

    <div id="toastContainer"></div>

    <div class="container">
        <header>
            <h1>Ollama Web Manager <small>v3.0</small></h1>
            <div class="theme-switcher">
                <button id="themeToggle" class="theme-toggle" title="Toggle light/dark theme">
                    <svg class="icon icon-light" style="display: none;"><use href="#icon-sun"></use></svg>
                    <svg class="icon icon-dark" style="display: none;"><use href="#icon-moon"></use></svg>
                    <span class="theme-text">Toggle Theme</span>
                </button>
            </div>
        </header>

        <section id="connection">
            <h2>
                <svg class="icon"><use href="#icon-connect"></use></svg> Connection
            </h2>
            <label for="ollamaUrl">Ollama Server URL:</label>
            <input type="url" id="ollamaUrl" placeholder="http://localhost:11434">
            <button id="connectBtn" title="Connect to Ollama server and refresh model list">
                 <svg class="icon"><use href="#icon-connect"></use></svg> Connect & Refresh
            </button>
            <span id="connectionStatus">Status: <span class="status-indicator disconnected"></span> Not Connected</span>
            <div id="ollamaInfo"></div>
            <p style="font-size: 0.8em; margin-top: 1rem; color: var(--text-muted);">
                <strong>Note:</strong> Ensure Ollama server is running and CORS is configured (e.g., `OLLAMA_ORIGINS=*`) if accessing from a different origin. Check browser console (F12) for errors.
            </p>
        </section>

        <main>
            <section id="modelManagement">
                <h2>
                    <svg class="icon"><use href="#icon-code"></use></svg> Model Management
                </h2>

                <div id="modelList">
                    <h3>Local Models</h3>
                    <label for="modelFilter">Filter models:</label>
                    <input type="search" id="modelFilter" placeholder="Search by name...">
                    <ul id="models">
                        <li>Connect to server to load models.</li>
                    </ul>
                    <button id="refreshModelsBtn" class="button-secondary" disabled title="Refresh the list of local models">
                        <svg class="icon"><use href="#icon-refresh"></use></svg> Refresh List
                    </button>
                </div>
                <hr>
                <div id="pullModel" class="operation-section">
                    <h3>Pull Model</h3>
                    <label for="pullModelName">Model Name (e.g., llama3:latest):</label>
                    <input type="text" id="pullModelName" placeholder="llama3:latest">
                    <div class="operation-controls">
                        <button id="pullBtn" disabled title="Download model from registry">
                            <svg class="icon"><use href="#icon-download"></use></svg> Pull Model
                        </button>
                        <button id="stopPullBtn" class="button-warning stop-button">
                             <svg class="icon"><use href="#icon-stop"></use></svg> Stop Pull
                        </button>
                    </div>
                    <progress id="pullProgress" value="0" max="100"></progress>
                    <span id="pullStatus" class="status-text"></span>
                </div>

                <div id="createModel" class="operation-section">
                     <h3>Create Model from Modelfile</h3>
                     <label for="createModelName">New Model Name (required):</label>
                     <input type="text" id="createModelName" placeholder="my-custom-model:latest">
                     <label for="createModelfileContent">Modelfile Content:</label>
                     <textarea id="createModelfileContent" placeholder="FROM llama3&#10;SYSTEM You are a helpful assistant."></textarea>
                     <div class="operation-controls">
                         <button id="createBtn" disabled title="Create a new model using the Modelfile above">
                             <svg class="icon"><use href="#icon-add"></use></svg> Create Model
                         </button>
                         <button id="stopCreateBtn" class="button-warning stop-button">
                              <svg class="icon"><use href="#icon-stop"></use></svg> Stop Create
                         </button>
                     </div>
                     <progress id="createProgress" value="0" max="100"></progress>
                     <span id="createStatus" class="status-text"></span>
                 </div>
            </section>

            <section id="modelInteraction">
                <h2>
                     <svg class="icon"><use href="#icon-chat"></use></svg> Model Interaction
                </h2>
                <div class="tabs">
                    <button class="tab-button active" data-tab="chat" title="Chat with a model"> <svg class="icon"><use href="#icon-chat"></use></svg> Chat </button>
                    <button class="tab-button" data-tab="generate" title="Generate text using a prompt"> <svg class="icon"><use href="#icon-play"></use></svg> Generate </button>
                    <button class="tab-button" data-tab="embeddings" title="Generate embeddings for text"> <svg class="icon"><use href="#icon-vector"></use></svg> Embeddings </button>
                    <button class="tab-button" data-tab="editor" title="View model info and edit Modelfiles"> <svg class="icon"><use href="#icon-edit"></use></svg> Info / Editor </button>
                </div>

                <!-- Chat Tab -->
                <div id="chatInterface" class="tab-content active">
                    <h3>Chat</h3>
                    <label for="chatModelSelect">Select Model:</label>
                    <select id="chatModelSelect" disabled> <option value="">-- Select Model --</option> </select>

                    <div id="chatOptions">
                         <label for="chatSystemPrompt">System Prompt (Optional):</label>
                         <input type="text" id="chatSystemPrompt" placeholder="e.g., You are a helpful assistant." title="Override the model's default system prompt for this session">
                    </div>

                    <div id="chatOutput"></div>

                    <div id="chatInputContainer">
                        <textarea id="chatInput" placeholder="Enter your message... (Shift+Enter for newline)" disabled rows="1"></textarea>
                        <div class="operation-controls">
                           <button id="sendChatBtn" disabled title="Send message"> Send </button>
                           <button id="stopChatBtn" class="button-warning stop-button" title="Stop generation">
                               <svg class="icon"><use href="#icon-stop"></use></svg> Stop
                           </button>
                        </div>
                    </div>
                    <div class="chat-session-controls">
                        <button id="clearChatBtn" class="button-secondary" title="Clear current chat history">Clear Chat</button>
                        <button id="saveChatBtn" class="button-secondary" title="Save chat session to browser storage">
                             <svg class="icon"><use href="#icon-save"></use></svg> Save Session
                        </button>
                        <button id="loadChatBtn" class="button-secondary" title="Load last saved chat session">
                             <svg class="icon"><use href="#icon-load"></use></svg> Load Session
                        </button>
                    </div>
                </div>

                <!-- Generate Tab -->
                <div id="generateInterface" class="tab-content">
                    <h3>Generate Text</h3>
                    <label for="generateModelSelect">Select Model:</label>
                    <select id="generateModelSelect" disabled> <option value="">-- Select Model --</option> </select>
                    <label for="generatePrompt">Prompt:</label>
                    <textarea id="generatePrompt" placeholder="Enter prompt here..." rows="5"></textarea>

                    <div class="advanced-options">
                        <h4>Advanced Options</h4>
                        <div class="options-grid">
                            <div>
                                <label for="generateTemp">Temperature:</label>
                                <input type="number" id="generateTemp" min="0" max="2" step="0.1" value="0.8" title="Controls randomness. Lower is more deterministic.">
                            </div>
                            <div>
                               <label for="generateSeed">Seed:</label>
                               <input type="number" id="generateSeed" min="0" step="1" placeholder="Random" title="Set a seed for reproducible results (if model supports). Leave blank for random.">
                            </div>
                            <div>
                               <label for="generateNumPredict">Max Tokens (num_predict):</label>
                               <input type="number" id="generateNumPredict" min="-1" step="1" placeholder="Default" title="Max number of tokens to predict (-1 for default/unlimited)">
                            </div>
                             <!-- Add more options here: top_k, top_p, stop sequences etc. -->
                        </div>
                    </div>

                    <div class="operation-controls">
                       <button id="generateBtn" disabled title="Generate text based on prompt and options">
                            <svg class="icon"><use href="#icon-play"></use></svg> Generate
                       </button>
                       <button id="stopGenerateBtn" class="button-warning stop-button" title="Stop generation">
                            <svg class="icon"><use href="#icon-stop"></use></svg> Stop
                       </button>
                    </div>
                    <label for="generateOutput">Output:</label>
                    <pre id="generateOutput"></pre>
                </div>

                <!-- Embeddings Tab -->
                <div id="embeddingsInterface" class="tab-content">
                    <h3>Generate Embeddings</h3>
                    <label for="embeddingsModelSelect">Select Model:</label>
                    <select id="embeddingsModelSelect" disabled> <option value="">-- Select Model --</option> </select>
                    <label for="embeddingsPrompt">Text to Embed:</label>
                    <textarea id="embeddingsPrompt" placeholder="Enter text here..." rows="4"></textarea>
                    <div class="operation-controls">
                       <button id="embeddingsBtn" disabled title="Generate embeddings vector for the text">
                            <svg class="icon"><use href="#icon-vector"></use></svg> Generate Embeddings
                       </button>
                       <!-- Stop button might not be applicable/useful for embeddings -->
                    </div>
                    <label for="embeddingsOutput">Embedding Vector (Truncated):</label>
                    <pre id="embeddingsOutput"></pre>
                </div>


                 <!-- Model Info / Editor Tab -->
                 <div id="editorInterface" class="tab-content">
                     <h3>Model Info / Modelfile Editor</h3>
                     <div class="editor-note">
                         <svg class="icon"><use href="#icon-info-circle"></use></svg>
                         Use the 'Info/Edit <svg class="icon" style="width:0.8em;height:0.8em;"><use href="#icon-edit"></use></svg>' button on a model in the list to load its details and Modelfile content here.
                         You can then edit the Modelfile content below and create a <strong>new</strong> model from it using the 'Create Model from Editor' button.
                     </div>
                     <div id="modelInfoDisplay" style="margin-bottom: 1.5rem;">
                         <h4>Loaded Model Details:</h4>
                         <pre id="modelInfoContent">Load a model using 'Info/Edit' to see details.</pre>
                     </div>

                     <h4>Edit Modelfile and Create New Model</h4>
                     <label for="editModelName">New Model Name (required):</label>
                     <input type="text" id="editModelName" placeholder="e.g., loaded-model-edited:latest">
                     <label for="modelfileEditor">Modelfile Content:</label>
                     <textarea id="modelfileEditor" placeholder="Modelfile content will appear here after loading..."></textarea>
                     <div class="operation-controls">
                        <button id="saveEditedModelBtn" class="button-success" disabled title="Create a NEW model using the edited content above">
                            <svg class="icon"><use href="#icon-add"></use></svg> Create Model from Editor
                        </button>
                        <button id="stopEditorCreateBtn" class="button-warning stop-button" title="Stop creation process">
                             <svg class="icon"><use href="#icon-stop"></use></svg> Stop Create
                        </button>
                        <button id="clearEditorBtn" class="button-secondary" title="Clear the editor fields">
                             Clear Editor
                        </button>
                     </div>
                     <progress id="editorCreateProgress" value="0" max="100"></progress>
                     <span id="editorCreateStatus" class="status-text"></span>
                 </div>

            </section>
        </main>

        <section id="statusLogContainer">
            <h2>Status Log</h2>
            <div id="statusLog">
                <p>Welcome! Enter your Ollama server URL and click Connect.</p>
            </div>
             <button id="clearLogBtn" class="button-secondary" title="Clear this log window">Clear Log</button>
        </section>

    </div> <!-- End Container -->

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/shell/shell.min.js"></script> <!-- Shell mode is close enough for Modelfile -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>

    <script>
        // --- DOM Elements ---
        const ollamaUrlInput = document.getElementById('ollamaUrl');
        const connectBtn = document.getElementById('connectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusIndicator = connectionStatus.querySelector('.status-indicator');
        const ollamaInfoDiv = document.getElementById('ollamaInfo');
        const modelFilterInput = document.getElementById('modelFilter');
        const refreshModelsBtn = document.getElementById('refreshModelsBtn');
        const modelListUl = document.getElementById('models');
        const statusLog = document.getElementById('statusLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const themeToggle = document.getElementById('themeToggle');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const toastContainer = document.getElementById('toastContainer');

        // Pull Model Elements
        const pullModelNameInput = document.getElementById('pullModelName');
        const pullBtn = document.getElementById('pullBtn');
        const stopPullBtn = document.getElementById('stopPullBtn');
        const pullProgress = document.getElementById('pullProgress');
        const pullStatus = document.getElementById('pullStatus');

        // Create Model Elements
        const createModelNameInput = document.getElementById('createModelName');
        const createModelfileContent = document.getElementById('createModelfileContent'); // Textarea element
        const createBtn = document.getElementById('createBtn');
        const stopCreateBtn = document.getElementById('stopCreateBtn');
        const createProgress = document.getElementById('createProgress');
        const createStatus = document.getElementById('createStatus');

        // Chat Elements
        const chatModelSelect = document.getElementById('chatModelSelect');
        const chatSystemPrompt = document.getElementById('chatSystemPrompt');
        const chatOutput = document.getElementById('chatOutput');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const stopChatBtn = document.getElementById('stopChatBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const saveChatBtn = document.getElementById('saveChatBtn');
        const loadChatBtn = document.getElementById('loadChatBtn');

        // Generate Elements
        const generateModelSelect = document.getElementById('generateModelSelect');
        const generatePrompt = document.getElementById('generatePrompt');
        const generateBtn = document.getElementById('generateBtn');
        const stopGenerateBtn = document.getElementById('stopGenerateBtn');
        const generateOutput = document.getElementById('generateOutput');
        const generateTempInput = document.getElementById('generateTemp');
        const generateSeedInput = document.getElementById('generateSeed');
        const generateNumPredictInput = document.getElementById('generateNumPredict');

        // Embeddings Elements
        const embeddingsModelSelect = document.getElementById('embeddingsModelSelect');
        const embeddingsPrompt = document.getElementById('embeddingsPrompt');
        const embeddingsBtn = document.getElementById('embeddingsBtn');
        const embeddingsOutput = document.getElementById('embeddingsOutput');

        // Editor Elements
        const modelInfoContent = document.getElementById('modelInfoContent');
        const editModelNameInput = document.getElementById('editModelName');
        const modelfileEditorTextarea = document.getElementById('modelfileEditor'); // Textarea element
        const saveEditedModelBtn = document.getElementById('saveEditedModelBtn');
        const stopEditorCreateBtn = document.getElementById('stopEditorCreateBtn');
        const clearEditorBtn = document.getElementById('clearEditorBtn');
        const editorCreateProgress = document.getElementById('editorCreateProgress');
        const editorCreateStatus = document.getElementById('editorCreateStatus');

        // --- State Variables ---
        let OLLAMA_API_URL = '';
        let currentChatHistory = [];
        let abortControllers = { pull: null, create: null, editorCreate: null, generate: null, chat: null, embeddings: null };
        let ollamaVersion = null;
        let connected = false;
        let createCmInstance = null; // CodeMirror instance for create
        let editorCmInstance = null; // CodeMirror instance for editor
        let currentModels = []; // Cache the list of models

        // --- Constants ---
        const LS_URL_KEY = 'ollama-web-manager-url';
        const LS_THEME_KEY = 'ollama-web-manager-theme';
        const LS_CHAT_HISTORY_KEY = 'ollama-web-manager-chat';
        const PRIMARY_RGB_MAP = {
            light: '0, 123, 255',
            dark: '13, 110, 253'
        }

        // --- SVG Icons --- (used in functions)
        const ICONS = {
            success: `<svg class="icon"><use href="#icon-check"></use></svg>`,
            error: `<svg class="icon"><use href="#icon-error"></use></svg>`,
            info: `<svg class="icon"><use href="#icon-info-circle"></use></svg>`,
            copy: `<svg class="icon"><use href="#icon-copy"></use></svg>`,
            trash: `<svg class="icon"><use href="#icon-trash"></use></svg>`,
            edit: `<svg class="icon"><use href="#icon-edit"></use></svg>`,
            infoCircle: `<svg class="icon"><use href="#icon-info"></use></svg>`,
            chat: `<svg class="icon"><use href="#icon-chat"></use></svg>`,
            refresh: `<svg class="icon"><use href="#icon-refresh"></use></svg>`,
            stop: `<svg class="icon"><use href="#icon-stop"></use></svg>`,
            save: `<svg class="icon"><use href="#icon-save"></use></svg>`,
            load: `<svg class="icon"><use href="#icon-load"></use></svg>`,
            vector: `<svg class="icon"><use href="#icon-vector"></use></svg>`,
            play: `<svg class="icon"><use href="#icon-play"></use></svg>`,
            download: `<svg class="icon"><use href="#icon-download"></use></svg>`,
            add: `<svg class="icon"><use href="#icon-add"></use></svg>`,
        };

        // --- Utility Functions ---
        function logMessage(message, type = 'info') {
             const p = document.createElement('p');
             const timestamp = new Date().toLocaleTimeString();
             const safeMessage = String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;");
             p.innerHTML = `<strong>[${timestamp}]</strong> ${safeMessage}`;
             p.className = `log-${type}`;
             statusLog.appendChild(p);
             statusLog.scrollTop = statusLog.scrollHeight;
        }

        function showToast(message, type = 'info', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = ICONS.info;
            if (type === 'success') icon = ICONS.success;
            if (type === 'error') icon = ICONS.error;

            toast.innerHTML = `${icon} <span>${String(message).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10); // Trigger fade in

            setTimeout(() => { // Auto dismiss
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function formatSize(bytes) { bytes = Number(bytes); if (bytes === 0 || !bytes || isNaN(bytes)) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.max(0, Math.floor(Math.log(bytes) / Math.log(k))); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(i === 0 ? 0 : 2))} ${sizes[i]}`; }
        function formatDate(dateString) { try { return new Date(dateString).toLocaleString(); } catch (e) { return dateString; } }
        function showTab(tabId) { tabContents.forEach(content => content.classList.remove('active')); tabButtons.forEach(button => button.classList.remove('active')); document.getElementById(`${tabId}Interface`)?.classList.add('active'); document.querySelector(`.tab-button[data-tab="${tabId}"]`)?.classList.add('active'); }
        function getTheme() { return document.documentElement.getAttribute('data-theme') || 'light'; }

        function updateFocusRingColor() {
             const theme = getTheme();
             const rgb = PRIMARY_RGB_MAP[theme] || PRIMARY_RGB_MAP['light'];
             document.documentElement.style.setProperty('--primary-rgb-val', rgb); // Use a different CSS variable if needed, or update the root directly (less safe if root var isn't defined)
             // If directly updating root (ensure --primary-rgb is defined):
             document.documentElement.style.setProperty('--primary-rgb', rgb);
         }


        // --- API Request Function ---
        async function makeApiRequest(endpoint, method = 'GET', body = null, isStreaming = false, progressCallback = null, abortSignal = null) {
            if (!connected && endpoint !== '/api/version') {
                 const errorMsg = `Cannot make request ${method} ${endpoint}: Not connected to Ollama server.`;
                 logMessage(errorMsg, 'error'); showToast(errorMsg, 'error');
                 throw new Error(errorMsg);
            }
            const url = `${OLLAMA_API_URL}${endpoint}`;
            const options = { method, headers: {}, signal: abortSignal, keepalive: true }; // Add keepalive
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    let errorBody = await response.text().catch(() => 'Could not read error body.');
                    throw new Error(`HTTP error! Status: ${response.status} (${response.statusText}). Endpoint: ${endpoint}. Body: ${errorBody}`);
                }
                if (isStreaming) {
                     if (!response.body) throw new Error("Response body is null, cannot stream.");
                     const reader = response.body.getReader(); const decoder = new TextDecoder(); let buffer = ''; let fullResponseText = '';
                     while (true) {
                         if (abortSignal?.aborted) throw new DOMException('Aborted', 'AbortError');
                         const { done, value } = await reader.read();
                         if (done) {
                             if (buffer.trim()) { try { const jsonChunk = JSON.parse(buffer); if (progressCallback) progressCallback(jsonChunk); else if (jsonChunk.response) fullResponseText += jsonChunk.response; else if (jsonChunk.message?.content) fullResponseText += jsonChunk.message.content; } catch (e) { logMessage(`Error parsing final streaming buffer: ${buffer} - ${e.message}`, 'warn'); } }
                             return progressCallback ? { done: true } : fullResponseText;
                         }
                         buffer += decoder.decode(value, { stream: true }); const lines = buffer.split('\n'); buffer = lines.pop();
                         for (const line of lines) { if (line.trim() === '') continue; try { const jsonChunk = JSON.parse(line); if (progressCallback) progressCallback(jsonChunk); else { if (jsonChunk.response) fullResponseText += jsonChunk.response; else if (jsonChunk.message?.content) fullResponseText += jsonChunk.message.content; } if (jsonChunk.done) return progressCallback ? jsonChunk : fullResponseText; } catch (e) { logMessage(`Error parsing streaming JSON line: ${line} - ${e.message}`, 'warn'); } }
                     }
                } else { if (response.status === 204 || (response.status === 200 && method === 'HEAD') || (response.status === 200 && method === 'DELETE')) { return { ok: true, status: response.status }; } const data = await response.json(); return data; }
            } catch (error) {
                 if (error.name === 'AbortError') { logMessage(`Request aborted by user: ${method} ${url}`, 'warn'); throw error; }
                 const errorMsg = `API Request Failed: ${method} ${url} - ${error.message}`;
                 logMessage(errorMsg, 'error'); showToast(`API Error: ${error.message.split('.')[0]}`, 'error', 6000); // Shorter toast message
                if (error instanceof TypeError && error.message.toLowerCase().includes('fetch')) { logMessage('-> Check CORS, network, and server URL.', 'error'); }
                throw new Error(errorMsg, { cause: error });
            }
        }

        // --- UI Update & Control Functions ---
        function updateConnectionStatus(status) {
             const wasConnected = connected; connected = (status === 'connected'); statusIndicator.className = `status-indicator ${status}`; let statusText = 'Not Connected'; if (status === 'connected') statusText = `Connected`; if (status === 'checking') statusText = 'Checking...'; connectionStatus.innerHTML = `Status: <span class="status-indicator ${status}"></span> ${statusText}`; ollamaInfoDiv.textContent = connected && ollamaVersion ? `Ollama Version: ${ollamaVersion}` : ''; if (connected !== wasConnected) { disableControls(!connected); } refreshModelsBtn.disabled = !connected;
         }
        function disableControls(disabled) {
            const elements = [ refreshModelsBtn, pullBtn, pullModelNameInput, modelFilterInput, createBtn, createModelNameInput, chatModelSelect, chatInput, sendChatBtn, clearChatBtn, saveChatBtn, loadChatBtn, chatSystemPrompt, generateModelSelect, generatePrompt, generateBtn, generateTempInput, generateSeedInput, generateNumPredictInput, embeddingsModelSelect, embeddingsPrompt, embeddingsBtn, editModelNameInput, saveEditedModelBtn, clearEditorBtn ];
            elements.forEach(el => { if (el) el.disabled = disabled; });
            modelListUl.querySelectorAll('button').forEach(btn => btn.disabled = disabled);
             [createCmInstance, editorCmInstance].forEach(cm => { if (cm) cm.setOption("readOnly", disabled); });
            if (disabled) { [pullProgress, createProgress, editorCreateProgress].forEach(p => p.classList.remove('active')); [pullStatus, createStatus, editorCreateStatus].forEach(s => s.textContent = ''); stopAllOperations(); }
            else { listLocalModels().then(models => { const haveModels = models && models.length > 0; [chatModelSelect, generateModelSelect, embeddingsModelSelect].forEach(s => s.disabled = !haveModels); }).catch(() => { [chatModelSelect, generateModelSelect, embeddingsModelSelect].forEach(s => s.disabled = true); }); }
        }
        function populateModelDropdowns(models) {
             const optionsHtml = models.map(m => `<option value="${m.name}">${m.name}</option>`).join(''); const placeholder = '<option value="">-- Select Model --</option>';
             [chatModelSelect, generateModelSelect, embeddingsModelSelect].forEach(sel => { const currentVal = sel.value; sel.innerHTML = placeholder + optionsHtml; if (models.some(m => m.name === currentVal)) sel.value = currentVal; sel.disabled = !connected || models.length === 0; });
             return models;
         }

        // --- CodeMirror Setup ---
        function initializeCodeMirror(textareaId) {
            const textarea = document.getElementById(textareaId); if (!textarea) return null;
            try {
                return CodeMirror.fromTextArea(textarea, { lineNumbers: true, mode: 'shell', theme: getTheme() === 'dark' ? 'material-darker' : 'neat', matchBrackets: true, indentUnit: 4, tabSize: 4, indentWithTabs: false, lineWrapping: true, readOnly: !connected });
            } catch (e) { logMessage(`CodeMirror initialization failed for ${textareaId}: ${e.message}`, 'error'); return null; }
        }
        function updateCodeMirrorTheme(cmInstance) { if (cmInstance) { cmInstance.setOption('theme', getTheme() === 'dark' ? 'material-darker' : 'neat'); } }

        // --- Operation Control ---
        function startOperation(opType, startButton, stopButton) { abortControllers[opType] = new AbortController(); startButton.disabled = true; const baseText = startButton.dataset.defaultText || startButton.textContent.replace('...', '').replace(/<span.*<\/span>/, '').trim(); startButton.innerHTML = `<span class="spinner"></span> ${baseText.replace(/<svg.*?>.*?<\/svg>/g, '')}...`; stopButton.classList.add('active'); stopButton.disabled = false; } // Remove existing icon before adding spinner
        function endOperation(opType, startButton, stopButton, defaultText) { if (abortControllers[opType]) abortControllers[opType] = null; const buttonHTML = startButton.dataset.defaultText || defaultText; startButton.disabled = !connected; startButton.innerHTML = buttonHTML; stopButton.classList.remove('active'); stopButton.disabled = true; }
        function stopOperation(opType) { if (abortControllers[opType]) { logMessage(`User requested stop for operation: ${opType}`, 'warn'); abortControllers[opType].abort(); } }
        function stopAllOperations() { Object.keys(abortControllers).forEach(opType => stopOperation(opType)); }

        // --- Core Action Functions ---
        async function connectAndRefresh() {
            OLLAMA_API_URL = ollamaUrlInput.value.trim().replace(/\/$/, ''); if (!OLLAMA_API_URL) { showToast('Please enter a valid Ollama Server URL.', 'error'); return; }
            localStorage.setItem(LS_URL_KEY, OLLAMA_API_URL); updateConnectionStatus('checking'); ollamaVersion = null;
            try {
                logMessage(`Checking connection to ${OLLAMA_API_URL}...`, 'info');
                const versionData = await makeApiRequest('/api/version'); ollamaVersion = versionData.version || 'Unknown';
                logMessage(`Ollama version check successful: ${ollamaVersion}`, 'info');
                updateConnectionStatus('connected'); showToast(`Connected to Ollama ${ollamaVersion}`, 'success');
                await listLocalModels();
            } catch (error) { updateConnectionStatus('disconnected'); modelListUl.innerHTML = '<li>Connection failed. Check URL, Ollama status, and CORS.</li>'; populateModelDropdowns([]); logMessage(`Connection failed: ${error.message}`, 'error'); ollamaVersion = null; }
        }
        async function listLocalModels() {
            if (!connected) { modelListUl.innerHTML = '<li>Not connected.</li>'; populateModelDropdowns([]); currentModels = []; return Promise.resolve([]); }
            logMessage('Fetching local models...', 'info'); refreshModelsBtn.disabled = true; refreshModelsBtn.innerHTML = `<span class="spinner"></span> Refreshing...`;
            try {
                const data = await makeApiRequest('/api/tags'); const models = data.models || [];
                currentModels = models.sort((a, b) => a.name.localeCompare(b.name)); renderModelList(currentModels);
                logMessage(`Found ${models.length} local models.`, 'info'); populateModelDropdowns(models); return models;
            } catch (error) { logMessage(`Error loading models: ${error.message}`, 'error'); modelListUl.innerHTML = '<li>Error loading models.</li>'; populateModelDropdowns([]); currentModels = []; throw error; }
            finally { refreshModelsBtn.disabled = !connected; refreshModelsBtn.innerHTML = `<svg class="icon"><use href="#icon-refresh"></use></svg> Refresh List`; modelListUl.querySelectorAll('button').forEach(btn => btn.disabled = !connected); }
        }
        function renderModelList(models) {
             modelListUl.innerHTML = ''; if (models.length === 0) { modelListUl.innerHTML = '<li>No local models found.</li>'; return; }
             const filterText = modelFilterInput.value.toLowerCase(); const filteredModels = models.filter(model => model.name.toLowerCase().includes(filterText));
             if (filteredModels.length === 0 && models.length > 0) { modelListUl.innerHTML = '<li>No models match filter.</li>'; return; }
             filteredModels.forEach(model => {
                 const li = document.createElement('li'); li.dataset.modelName = model.name;
                 const family = model.details?.family || ''; const params = model.details?.parameter_size || ''; const quant = model.details?.quantization_level || '';
                 li.innerHTML = `
                     <div class="model-details"> <span class="model-name">${model.name}</span> <span class="model-meta" title="${model.details ? `Family: ${family}, Params: ${params}, Quant: ${quant}` : ''}"> Size: ${formatSize(model.size)} | Modified: ${formatDate(model.modified_at)} ${family ? `| Family: ${family}` : ''} </span> </div>
                     <div class="model-actions"> <button class="btn-icon" data-action="info" data-model="${model.name}" title="Show Info & Load into Editor">${ICONS.edit}</button> <button class="btn-icon" data-action="chat" data-model="${model.name}" title="Chat with this Model">${ICONS.chat}</button> <button class="btn-icon" data-action="copy" data-model="${model.name}" title="Duplicate this Model">${ICONS.copy}</button> <button class="btn-icon" data-action="delete" data-model="${model.name}" title="Delete this Model">${ICONS.trash}</button> </div>`;
                 modelListUl.appendChild(li);
             });
             modelListUl.querySelectorAll('button').forEach(btn => btn.disabled = !connected);
         }
        async function pullModel() {
            const modelName = pullModelNameInput.value.trim(); if (!modelName) { showToast('Please enter a model name to pull.', 'warn'); return; }
            startOperation('pull', pullBtn, stopPullBtn); pullProgress.classList.add('active'); pullProgress.value = 0; pullStatus.textContent = 'Starting pull...';
            const progressCallback = (chunk) => { let statusText = chunk.status || ''; if (chunk.digest) statusText += ` | ${chunk.digest.substring(0, 15)}...`; if (chunk.total && chunk.completed) { const percent = Math.round((chunk.completed / chunk.total) * 100); pullProgress.value = percent; statusText += ` (${percent}%)`; } else if (chunk.status === 'success') { pullProgress.value = 100; statusText = 'Pull complete!'; } else { pullProgress.removeAttribute('value'); } pullStatus.textContent = statusText; if (chunk.status === 'success') { showToast(`Model ${modelName} pulled successfully.`, 'success'); listLocalModels(); setTimeout(() => { pullStatus.textContent = ''; pullProgress.classList.remove('active'); pullModelNameInput.value = ''; }, 3000); } };
            try { await makeApiRequest('/api/pull', 'POST', { name: modelName, stream: true }, true, progressCallback, abortControllers.pull.signal); }
            catch (error) { if (error.name !== 'AbortError') { logMessage(`Error pulling model ${modelName}: ${error.message}`, 'error'); pullStatus.textContent = `Error: ${error.message}`; } else { pullStatus.textContent = 'Pull cancelled.'; showToast('Pull operation cancelled.', 'info'); } pullProgress.classList.remove('active'); }
            finally { endOperation('pull', pullBtn, stopPullBtn, pullBtn.dataset.defaultText); }
        }
        async function createModelHandler(opType, modelName, modelfileContent, nameInput, cmInstance, progressElement, statusElement, buttonElement, stopButtonElement) {
            const currentModelfileContent = cmInstance ? cmInstance.getValue() : modelfileContent; if (!modelName || !currentModelfileContent) { showToast('Model name and Modelfile content are required.', 'warn'); statusElement.textContent = 'Missing model name or content.'; return; }
            startOperation(opType, buttonElement, stopButtonElement); progressElement.classList.add('active'); progressElement.value = 0; statusElement.textContent = 'Starting creation...';
            const progressCallback = (chunk) => { let statusText = chunk.status || ''; if (statusText.includes('transfer') && chunk.total && chunk.completed) { const percent = Math.round((chunk.completed / chunk.total) * 100); progressElement.value = percent; statusText += ` (${percent}%)`; } else if (statusText === 'success') { progressElement.value = 100; statusText = 'Model created successfully!'; } else { progressElement.removeAttribute('value'); } statusElement.textContent = statusText; if (chunk.status === 'success') { showToast(`Model ${modelName} created successfully.`, 'success'); listLocalModels(); setTimeout(() => { statusElement.textContent = ''; progressElement.classList.remove('active'); if (nameInput) nameInput.value = ''; if (cmInstance) cmInstance.setValue(''); }, 3000); } };
            try { await makeApiRequest('/api/create', 'POST', { name: modelName, modelfile: currentModelfileContent, stream: true }, true, progressCallback, abortControllers[opType].signal); }
            catch (error) { if (error.name !== 'AbortError') { logMessage(`Error creating model ${modelName}: ${error.message}`, 'error'); statusElement.textContent = `Error: ${error.message}`; } else { statusElement.textContent = 'Creation cancelled.'; showToast('Creation cancelled.', 'info');} progressElement.classList.remove('active'); }
            finally { endOperation(opType, buttonElement, stopButtonElement, buttonElement.dataset.defaultText); }
        }
        async function deleteModel(modelName) {
             if (!confirm(`Are you sure you want to delete the model "${modelName}"? This cannot be undone.`)) return;
             logMessage(`Attempting to delete model: ${modelName}...`, 'info'); showToast(`Deleting ${modelName}...`, 'info');
             try { await makeApiRequest('/api/delete', 'DELETE', { name: modelName }); showToast(`Model "${modelName}" deleted successfully.`, 'success'); listLocalModels(); [chatModelSelect, generateModelSelect, embeddingsModelSelect].forEach(sel => { if (sel.value === modelName) sel.value = ''; }); if (editModelNameInput.value.startsWith(modelName)) clearEditor(); }
             catch (error) { logMessage(`Failed to delete model "${modelName}": ${error.message}`, 'error'); }
        }
        async function showModelInfo(modelName) {
             logMessage(`Fetching info for model: ${modelName}...`, 'info'); modelInfoContent.textContent = 'Loading...'; if (editorCmInstance) editorCmInstance.setValue(''); editModelNameInput.value = ''; saveEditedModelBtn.disabled = true;
             try {
                 const data = await makeApiRequest('/api/show', 'POST', { name: modelName }); const modelfileContent = data.modelfile || '# Modelfile content not available';
                 let details = `Model:          ${modelName}\n`; details += `Modified:       ${formatDate(data.modified_at)}\n`; details += `Size:           ${formatSize(data.size)}\n`;
                 if (data.details) { details += `Family:         ${data.details.family || 'N/A'}\n`; details += `Parameters:     ${data.details.parameter_size || 'N/A'}\n`; details += `Quantization:   ${data.details.quantization_level || 'N/A'}\n`; }
                 details += `\n----- Parameters -----\n${data.parameters || 'Not Available'}\n`; details += `\n----- Template -----\n${data.template || 'Not Available'}\n`;
                 modelInfoContent.textContent = details;
                 if(editorCmInstance) { editorCmInstance.setValue(modelfileContent); setTimeout(() => editorCmInstance.refresh(), 1); }
                 const baseName = modelName.includes(':') ? modelName.split(':')[0] : modelName; editModelNameInput.value = `${baseName}-edited:latest`;
                 saveEditedModelBtn.disabled = !connected; logMessage(`Info loaded for ${modelName}`, 'success'); showTab('editor');
             } catch (error) { logMessage(`Failed to get info for model "${modelName}": ${error.message}`, 'error'); modelInfoContent.textContent = `Error loading details: ${error.message}`; saveEditedModelBtn.disabled = true; }
        }
        async function copyModel(modelName) {
              const suggestedName = modelName.includes(':') ? `${modelName.split(':')[0]}-copy:${modelName.split(':')[1]}` : `${modelName}-copy`; const newName = prompt(`Enter new name for the copied model (from ${modelName}):`, suggestedName);
              if (!newName || newName.trim() === '' || newName.trim() === modelName) { logMessage('Copy cancelled.', 'warn'); return; }
              logMessage(`Attempting to copy model ${modelName} to ${newName}...`, 'info'); showToast(`Copying ${modelName}...`, 'info');
              try { await makeApiRequest('/api/copy', 'POST', { source: modelName, destination: newName }); showToast(`Model copied successfully to "${newName}".`, 'success'); listLocalModels(); }
              catch (error) { logMessage(`Failed to copy model: ${error.message}`, 'error'); }
        }
        function clearEditor() { modelInfoContent.textContent = 'Load a model using \'Info/Edit\' to see details.'; if(editorCmInstance) editorCmInstance.setValue(''); editModelNameInput.value = ''; saveEditedModelBtn.disabled = true; editorCreateStatus.textContent = ''; editorCreateProgress.classList.remove('active'); logMessage('Editor fields cleared.', 'info'); }

        // --- Chat ---
        function renderChat() {
             chatOutput.innerHTML = ''; currentChatHistory.forEach((msg, index) => { const isLastModelMessage = msg.role === 'assistant' && index === currentChatHistory.length - 1; appendChatMessage(msg.role, msg.content, false, isLastModelMessage); });
             chatOutput.scrollTop = chatOutput.scrollHeight; addCodeCopyButtons();
         }
        function appendChatMessage(role, content, addToHistory = true, isLastModelMessage = false) {
            if (addToHistory) currentChatHistory.push({ role, content });
            const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message', role === 'user' ? 'user' : 'assistant');
            let htmlContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/```(\w*?)\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code class="language-${lang}">${code.trim()}</code></pre>`).replace(/`([^`]+?)`/g, '<code>$1</code>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
            messageDiv.innerHTML = `<strong>${role === 'user' ? 'You' : 'Model'}</strong><div class="message-content">${htmlContent}</div>`;
            if (role === 'assistant') {
                 const actionsDiv = document.createElement('div'); actionsDiv.className = 'chat-message-actions';
                 actionsDiv.innerHTML = `<button class="btn-icon chat-copy-message" title="Copy message">${ICONS.copy}</button>`;
                 if (isLastModelMessage) { actionsDiv.innerHTML += `<button class="btn-icon chat-regenerate" title="Regenerate response">${ICONS.refresh}</button>`; }
                 messageDiv.appendChild(actionsDiv);
                 actionsDiv.querySelector('.chat-copy-message')?.addEventListener('click', (e) => { e.stopPropagation(); navigator.clipboard.writeText(content).then(() => showToast('Message copied!', 'success', 2000)).catch(err => showToast(`Copy failed: ${err}`, 'error')); });
                 actionsDiv.querySelector('.chat-regenerate')?.addEventListener('click', (e) => { e.stopPropagation(); regenerateLastResponse(); });
            }
            chatOutput.appendChild(messageDiv); chatOutput.scrollTop = chatOutput.scrollHeight; return messageDiv;
        }
         function addCodeCopyButtons() { chatOutput.querySelectorAll('pre').forEach(pre => { if (pre.querySelector('.code-copy-button')) return; const codeContent = pre.querySelector('code')?.textContent || ''; const copyBtn = document.createElement('button'); copyBtn.textContent = 'Copy'; copyBtn.className = 'code-copy-button'; copyBtn.title = 'Copy code block'; copyBtn.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(codeContent).then(() => showToast('Code copied!', 'success', 2000)).catch(err => showToast(`Copy failed: ${err}`, 'error')); }; pre.appendChild(copyBtn); }); }
        async function sendChatMessage(isRegeneration = false) {
             const model = chatModelSelect.value; let prompt = ''; let historyToSend = [...currentChatHistory];
             if (isRegeneration) { if (historyToSend.length < 2 || historyToSend[historyToSend.length - 2].role !== 'user') { showToast('Cannot regenerate.', 'warn'); return; } historyToSend.pop(); prompt = historyToSend[historyToSend.length-1].content; logMessage('Regenerating last response...', 'info'); }
             else { prompt = chatInput.value.trim(); if (!model || !prompt) { showToast('Select model and enter message.', 'warn'); return; } appendChatMessage('user', prompt); chatInput.value = ''; chatInput.style.height = '50px'; historyToSend = [...currentChatHistory]; }
             const systemPromptContent = chatSystemPrompt.value.trim(); let messagesPayload = [...historyToSend];
             if (systemPromptContent) { if (messagesPayload.length > 0 && messagesPayload[0].role === 'system') { messagesPayload[0].content = systemPromptContent; } else { messagesPayload.unshift({ role: 'system', content: systemPromptContent }); } logMessage(`Using custom system prompt.`, 'info'); }
             startOperation('chat', sendChatBtn, stopChatBtn); chatInput.disabled = true; let fullModelResponse = ''; let modelMessageDiv = null; let historyAdded = false;
             const progressCallback = (chunk) => { if (chunk.done === true) { if (!abortControllers.chat?.signal.aborted && !historyAdded) { currentChatHistory.push({ role: 'assistant', content: fullModelResponse }); historyAdded = true; renderChat(); } return; } if (chunk.message?.content) { const contentPart = chunk.message.content; fullModelResponse += contentPart; if (!modelMessageDiv) modelMessageDiv = appendChatMessage('assistant', '', false, true); let htmlContent = fullModelResponse.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/```(\w*?)\n([\s\S]*?)```/g, (match, lang, code) => `<pre><code class="language-${lang}">${code.trim()}</code></pre>`).replace(/`([^`]+?)`/g, '<code>$1</code>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>'); const contentDiv = modelMessageDiv.querySelector('.message-content'); if(contentDiv) contentDiv.innerHTML = htmlContent; chatOutput.scrollTop = chatOutput.scrollHeight; } if (chunk.done && !abortControllers.chat?.signal.aborted && !historyAdded) { currentChatHistory.push({ role: 'assistant', content: fullModelResponse }); historyAdded = true; renderChat(); } };
             try { await makeApiRequest('/api/chat', 'POST', { model: model, messages: messagesPayload, stream: true }, true, progressCallback, abortControllers.chat.signal); if (!abortControllers.chat?.signal.aborted && !historyAdded) { currentChatHistory.push({ role: 'assistant', content: fullModelResponse }); historyAdded = true; renderChat(); } addCodeCopyButtons(); }
             catch (error) { if (error.name !== 'AbortError') { logMessage(`Chat error: ${error.message}`, 'error'); appendChatMessage('assistant', `[Error: ${error.message}]`, false); } else { logMessage('Chat cancelled.', 'warn'); showToast('Chat cancelled.', 'info'); if (modelMessageDiv) { const contentDiv = modelMessageDiv.querySelector('.message-content'); if(contentDiv) contentDiv.innerHTML += ' [Cancelled]'; } else { appendChatMessage('assistant', '[Chat cancelled]', false); } } }
             finally { endOperation('chat', sendChatBtn, stopChatBtn, 'Send'); chatInput.disabled = !connected; if(connected) chatInput.focus(); }
        }
        function regenerateLastResponse() { if (currentChatHistory.length < 2) { showToast('Nothing to regenerate.', 'warn'); return; } if (currentChatHistory[currentChatHistory.length - 1].role === 'assistant') { currentChatHistory.pop(); renderChat(); sendChatMessage(true); } else { showToast('Last message was not from the model.', 'warn'); } }
        function saveChat() { try { localStorage.setItem(LS_CHAT_HISTORY_KEY, JSON.stringify(currentChatHistory)); showToast('Chat session saved.', 'success'); } catch (e) { showToast(`Failed to save chat: ${e.message}`, 'error'); logMessage(`localStorage error: ${e.message}`, 'error'); } }
        function loadChat() { try { const savedChat = localStorage.getItem(LS_CHAT_HISTORY_KEY); if (savedChat) { const parsedChat = JSON.parse(savedChat); if (Array.isArray(parsedChat)) { currentChatHistory = parsedChat; renderChat(); showToast('Chat session loaded.', 'success'); } else { showToast('Invalid chat data in storage.', 'warn'); } } else { showToast('No saved chat session found.', 'info'); } } catch (e) { showToast(`Failed to load chat: ${e.message}`, 'error'); logMessage(`localStorage error: ${e.message}`, 'error'); } }

        // --- Generate ---
        async function generateText() {
            const model = generateModelSelect.value; const prompt = generatePrompt.value.trim(); if (!model || !prompt) { showToast('Select model and enter prompt.', 'warn'); return; }
             const options = { temperature: parseFloat(generateTempInput.value) || undefined, seed: parseInt(generateSeedInput.value) || undefined, num_predict: parseInt(generateNumPredictInput.value) || undefined, };
             Object.keys(options).forEach(key => options[key] === undefined && delete options[key]);
            startOperation('generate', generateBtn, stopGenerateBtn); generateOutput.textContent = ''; let fullResponse = ''; const startTime = Date.now();
            const progressCallback = (chunk) => { if (chunk.done === true) { const duration = ((Date.now() - startTime) / 1000).toFixed(2); let summary = `Gen finished in ${duration}s.`; if (chunk.total_duration) summary += ` Eval: ${(chunk.eval_duration / 1e9).toFixed(2)}s`; if (chunk.eval_count) summary += ` Tokens: ${chunk.eval_count}`; if (chunk.eval_count && chunk.eval_duration > 0) summary += ` (${(chunk.eval_count / (chunk.eval_duration / 1e9)).toFixed(1)} t/s)`; logMessage(summary, 'success'); generateOutput.textContent += `\n\n[${summary}]`; return; } if (chunk.response) { fullResponse += chunk.response; generateOutput.textContent = fullResponse; } };
            try { await makeApiRequest('/api/generate', 'POST', { model: model, prompt: prompt, stream: true, options: Object.keys(options).length > 0 ? options : undefined }, true, progressCallback, abortControllers.generate.signal); }
            catch (error) { if (error.name !== 'AbortError') { logMessage(`Generation error: ${error.message}`, 'error'); generateOutput.textContent = `Error: ${error.message}`; } else { logMessage('Generation cancelled.', 'warn'); showToast('Generation cancelled.', 'info'); generateOutput.textContent += '\n[Generation cancelled]'; } }
            finally { endOperation('generate', generateBtn, stopGenerateBtn, generateBtn.dataset.defaultText); }
        }

        // --- Embeddings ---
        async function generateEmbeddings() {
            const model = embeddingsModelSelect.value; const prompt = embeddingsPrompt.value.trim(); if (!model || !prompt) { showToast('Select model and enter text.', 'warn'); return; }
            embeddingsBtn.disabled = true; embeddingsBtn.innerHTML = `<span class="spinner"></span> Generating...`; embeddingsOutput.textContent = 'Generating...'; abortControllers.embeddings = new AbortController();
            try {
                const data = await makeApiRequest('/api/embeddings', 'POST', { model: model, prompt: prompt }, false, null, abortControllers.embeddings.signal);
                if (data.embedding && Array.isArray(data.embedding)) { embeddingsOutput.textContent = `[${data.embedding.slice(0, 20).map(n => n.toFixed(4)).join(', ')} ... ] (${data.embedding.length} dimensions)`; showToast(`Generated ${data.embedding.length}-dimension embedding.`, 'success'); }
                else { throw new Error('Invalid embedding format received.'); }
            } catch (error) { if (error.name !== 'AbortError') { logMessage(`Embeddings error: ${error.message}`, 'error'); embeddingsOutput.textContent = `Error: ${error.message}`; } else { embeddingsOutput.textContent = 'Generation cancelled.'; showToast('Embeddings generation cancelled.', 'info'); } }
            finally { embeddingsBtn.disabled = !connected; embeddingsBtn.innerHTML = embeddingsBtn.dataset.defaultText; abortControllers.embeddings = null; }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            connectBtn.addEventListener('click', connectAndRefresh);
            refreshModelsBtn.addEventListener('click', listLocalModels);
            modelFilterInput.addEventListener('input', () => renderModelList(currentModels));

             // Store default button HTML for reset (includes icon)
             document.querySelectorAll('button[id]').forEach(btn => { if(btn.id) btn.dataset.defaultText = btn.innerHTML; });

            // Pull
            pullBtn.addEventListener('click', pullModel); stopPullBtn.addEventListener('click', () => stopOperation('pull'));
            // Create (Direct)
            createBtn.addEventListener('click', () => createModelHandler('create', createModelNameInput.value.trim(), null, createModelNameInput, createCmInstance, createProgress, createStatus, createBtn, stopCreateBtn)); stopCreateBtn.addEventListener('click', () => stopOperation('create'));
            // Editor Create
            saveEditedModelBtn.addEventListener('click', () => createModelHandler('editorCreate', editModelNameInput.value.trim(), null, editModelNameInput, editorCmInstance, editorCreateProgress, editorCreateStatus, saveEditedModelBtn, stopEditorCreateBtn)); stopEditorCreateBtn.addEventListener('click', () => stopOperation('editorCreate')); clearEditorBtn.addEventListener('click', clearEditor);
            // Model List Actions
            modelListUl.addEventListener('click', async (event) => {
                const button = event.target.closest('button[data-action]'); if (!button || button.disabled || !connected) return;
                const action = button.dataset.action; const modelName = button.dataset.model; const originalHTML = button.innerHTML; button.disabled = true; button.innerHTML = `<span class="spinner"></span>`;
                try {
                    switch (action) { case 'delete': await deleteModel(modelName); break; case 'info': await showModelInfo(modelName); break; case 'chat': chatModelSelect.value = modelName; embeddingsModelSelect.value = modelName; generateModelSelect.value = modelName; showTab('chat'); chatInput.focus(); break; case 'copy': await copyModel(modelName); break; }
                } finally { button.disabled = !connected; button.innerHTML = originalHTML; }
            });
            // Chat
            sendChatBtn.addEventListener('click', () => sendChatMessage(false)); stopChatBtn.addEventListener('click', () => stopOperation('chat'));
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(false); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight > 250 ? 250 : chatInput.scrollHeight) + 'px'; });
            clearChatBtn.addEventListener('click', () => { currentChatHistory = []; renderChat(); showToast('Chat history cleared.', 'info'); chatSystemPrompt.value = ''; });
            saveChatBtn.addEventListener('click', saveChat); loadChatBtn.addEventListener('click', loadChat);
            // Generate
            generateBtn.addEventListener('click', generateText); stopGenerateBtn.addEventListener('click', () => stopOperation('generate'));
            // Embeddings
            embeddingsBtn.addEventListener('click', generateEmbeddings);
            // Tabs
            tabButtons.forEach(button => button.addEventListener('click', () => { showTab(button.getAttribute('data-tab')); if (button.getAttribute('data-tab') === 'editor' && editorCmInstance) editorCmInstance.refresh(); if (button.getAttribute('data-tab') === 'create' && createCmInstance) createCmInstance.refresh(); }));
            // Log & Theme
            clearLogBtn.addEventListener('click', () => { statusLog.innerHTML = ''; logMessage('Log cleared.', 'info'); });
            themeToggle.addEventListener('click', () => {
                const newTheme = getTheme() === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem(LS_THEME_KEY, newTheme);
                updateCodeMirrorTheme(createCmInstance); updateCodeMirrorTheme(editorCmInstance); updateFocusRingColor();
                document.querySelector('.icon-light').style.display = newTheme === 'dark' ? 'none' : 'inline-block'; document.querySelector('.icon-dark').style.display = newTheme === 'dark' ? 'inline-block' : 'none';
            });
        }

        // --- Initialization ---
        function initialize() {
            const savedTheme = localStorage.getItem(LS_THEME_KEY); const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches; const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', initialTheme); document.querySelector('.icon-light').style.display = initialTheme === 'dark' ? 'none' : 'inline-block'; document.querySelector('.icon-dark').style.display = initialTheme === 'dark' ? 'inline-block' : 'none';
            updateFocusRingColor(); // Set initial focus ring color

            const savedUrl = localStorage.getItem(LS_URL_KEY); if (savedUrl) { ollamaUrlInput.value = savedUrl; }

            // Initialize CodeMirror after theme and DOM are ready
            createCmInstance = initializeCodeMirror('createModelfileContent');
            editorCmInstance = initializeCodeMirror('modelfileEditor');

            setupEventListeners(); disableControls(true); logMessage('Ollama Web Manager V3 initialized. Connect to server.', 'info');
            if (ollamaUrlInput.value) { logMessage('Attempting auto-connect...', 'info'); connectAndRefresh(); }
        }

        // --- Run ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>